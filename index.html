<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Places CSV ç³»çµ±å»ºç½®æ•™å­¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .step-content { display: none; }
        .step-content.active { display: block; }
        .code-block { background: #1e293b; color: #f8fafc; padding: 1rem; border-radius: 0.5rem; overflow-x: auto; font-family: monospace; font-size: 0.875rem; line-height: 1.5; max-height: 300px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans">
    <div class="max-w-4xl mx-auto py-10 px-4">
        <header class="text-center mb-10">
            <h1 class="text-3xl font-extrabold text-indigo-700 mb-2">Google Places CSV æŸ¥è©¢ç³»çµ±</h1>
            <p class="text-slate-500">äº’å‹•å¼å»ºç½®æŒ‡å—ï¼šå¾é›¶é–‹å§‹éƒ¨ç½²æ‚¨çš„æŸ¥è©¢å·¥å…·</p>
        </header>

        <div id="intro-section" class="bg-white shadow-xl rounded-2xl p-8 mb-8 border border-slate-200">
            <h2 class="text-2xl font-bold mb-4 text-slate-800">1. ç³»çµ±é è¦½èˆ‡ç¯„ä¾‹</h2>
            <div class="grid md:grid-cols-2 gap-6">
                <div class="space-y-4">
                    <p class="font-semibold text-indigo-600">ğŸ”— å®˜æ–¹æ¼”ç¤ºç¶²å€ï¼š</p>
                    <a href="https://script.google.com/a/macros/gapp.ylsh.ilc.edu.tw/s/AKfycbxeAdd4WlQRk5P4Wawg67yLaDI2z5U3ESrxdbh2BBEoq3-kEhDBORIYwtZcfSgU0yvr/exec" target="_blank" class="block p-3 bg-slate-100 rounded-lg text-blue-600 break-all underline text-sm">é»æ­¤é–‹å•Ÿç¤ºç¯„ç¶²é </a>
                </div>
                <div class="space-y-2">
                    <p class="font-semibold text-emerald-600">ğŸ“Š è¼¸å‡ºçµæœ (CSV) ç¯„ä¾‹ï¼š</p>
                    <div class="text-xs bg-slate-800 text-slate-300 p-3 rounded-lg font-mono">
                        "åç¨±","ç·¯åº¦","ç¶“åº¦","è©•åˆ†","åœ°å€","é¡å‹","ç”¨æˆ¶è©•åˆ†ç¸½æ•¸"<br>
                        "å®œè˜­é«˜ä¸­",24.75,121.74,4.5,"å®œè˜­ç¸£å®œè˜­å¸‚å¾©èˆˆè·¯ä¸‰æ®µ8è™Ÿ","school",150
                    </div>
                </div>
            </div>
            <button onclick="startTutorial()" class="mt-8 w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 transition shadow-lg">é–‹å§‹å¯¦éš›å®‰è£æ­¥é©Ÿ â†’</button>
        </div>

        <div id="tutorial-section" class="hidden">
            <div class="mb-6 bg-slate-200 rounded-full h-2">
                <div id="progress-bar" class="bg-indigo-600 h-2 rounded-full transition-all duration-500" style="width: 20%"></div>
            </div>

            <div id="step-container" class="bg-white shadow-xl rounded-2xl p-8 mb-6 border border-slate-200">
                
                <div class="step-content active" id="step1">
                    <h3 class="text-xl font-bold mb-4 flex items-center"><span class="bg-indigo-100 text-indigo-700 w-8 h-8 rounded-full inline-flex items-center justify-center mr-2 text-sm">1</span> å–å¾— Google Places API Key</h3>
                    <p class="text-slate-600 mb-4">è«‹å…ˆè‡³ <a href="https://console.cloud.google.com/" target="_blank" class="text-indigo-600 underline">Google Cloud Console</a> å•Ÿç”¨ **Places API** ä¸¦å»ºç«‹ä¸€å€‹ API é‡‘é‘°ã€‚é€™å°‡ä½œç‚ºç³»çµ±æœå°‹åœ°æ¨™çš„æ†‘è­‰ã€‚</p>
                </div>

                <div class="step-content" id="step2">
                    <h3 class="text-xl font-bold mb-4 flex items-center"><span class="bg-indigo-100 text-indigo-700 w-8 h-8 rounded-full inline-flex items-center justify-center mr-2 text-sm">2</span> è¨­å®šæŒ‡ä»¤ç¢¼å±¬æ€§</h3>
                    <p class="text-slate-600 mb-2">åœ¨ Google Apps Script å°ˆæ¡ˆä¸­ï¼Œé»é¸å·¦å´ **âš™ï¸ å°ˆæ¡ˆè¨­å®š**ï¼Œæ–°å¢ä»¥ä¸‹å±¬æ€§ï¼š</p>
                    <div class="bg-slate-50 p-4 rounded-lg border font-mono text-sm">
                        <span class="text-indigo-700 font-bold">GOOGLE_PLACES_API_KEY</span> = <span class="text-slate-400">æ‚¨çš„é‡‘é‘°å€¼</span>
                    </div>
                </div>

                <div class="step-content" id="step3">
                    <h3 class="text-xl font-bold mb-4 flex items-center"><span class="bg-indigo-100 text-indigo-700 w-8 h-8 rounded-full inline-flex items-center justify-center mr-2 text-sm">3</span> è²¼ä¸Šå¾Œç«¯ç¨‹å¼ç¢¼ (Code.gs)</h3>
                    <p class="text-slate-600 mb-4">è«‹å°‡ GAS å°ˆæ¡ˆä¸­ `Code.gs` çš„å…§å®¹æ›¿æ›ç‚ºï¼š</p>
                    <div class="relative group">
                        <button onclick="copyCode('code-gs-text')" class="absolute right-4 top-4 bg-indigo-600 text-white px-3 py-1 rounded text-xs hover:bg-indigo-700">è¤‡è£½</button>
                        <pre class="code-block" id="code-gs-display"></pre>
                    </div>
                </div>

                <div class="step-content" id="step4">
                    <h3 class="text-xl font-bold mb-4 flex items-center"><span class="bg-indigo-100 text-indigo-700 w-8 h-8 rounded-full inline-flex items-center justify-center mr-2 text-sm">4</span> è²¼ä¸Šå‰ç«¯ç¨‹å¼ç¢¼ (Index.html)</h3>
                    <p class="text-slate-600 mb-4">åœ¨ GAS é»æ“Š `+` æ–°å¢ä¸€å€‹ HTML æª”æ¡ˆï¼Œå‘½åç‚º **Index**ï¼Œä¸¦è²¼ä¸Šï¼š</p>
                    <div class="relative group">
                        <button onclick="copyCode('index-html-text')" class="absolute right-4 top-4 bg-emerald-600 text-white px-3 py-1 rounded text-xs hover:bg-emerald-700">è¤‡è£½</button>
                        <pre class="code-block" id="index-html-display"></pre>
                    </div>
                </div>

                <div class="step-content" id="step5">
                    <h3 class="text-xl font-bold mb-4 flex items-center"><span class="bg-indigo-100 text-indigo-700 w-8 h-8 rounded-full inline-flex items-center justify-center mr-2 text-sm">5</span> å®Œæˆéƒ¨ç½²</h3>
                    <p class="text-slate-600 mb-4">é»æ“Šã€Œéƒ¨ç½²ã€â†’ã€Œæ–°å¢éƒ¨ç½²ã€ï¼Œé¸æ“‡ã€Œç¶²é æ‡‰ç”¨ç¨‹å¼ã€ã€‚</p>
                    <ul class="list-disc ml-6 text-slate-600 space-y-2">
                        <li>åŸ·è¡Œèº«åˆ†ï¼šæˆ‘</li>
                        <li>å­˜å–æ¬Šé™ï¼šçŸ¥é“é€£çµçš„äºº</li>
                    </ul>
                </div>
            </div>

            <div class="flex justify-between">
                <button id="prevBtn" onclick="changeStep(-1)" class="bg-slate-200 text-slate-600 px-6 py-2 rounded-xl font-bold disabled:opacity-0 transition">ä¸Šä¸€æ­¥</button>
                <button id="nextBtn" onclick="changeStep(1)" class="bg-indigo-600 text-white px-6 py-2 rounded-xl font-bold hover:bg-indigo-700 transition shadow-lg">ä¸‹ä¸€æ­¥</button>
            </div>
        </div>
    </div>

    <textarea id="code-gs-text" class="hidden">function doGet() {
  return HtmlService.createHtmlOutputFromFile('Index')
    .setTitle('Google Places CSV æŸ¥è©¢')
    .addMetaTag('viewport', 'width=device-width, initial-scale=1');
}

function searchPlacesCSV(keyword, lat, lng, radius) {
  const apiKey = PropertiesService
    .getScriptProperties()
    .getProperty('GOOGLE_PLACES_API_KEY');

  if (!apiKey) {
    throw new Error('å°šæœªè¨­å®š GOOGLE_PLACES_API_KEY');
  }

  const baseUrl = 'https://maps.googleapis.com/maps/api/place/textsearch/json';
  const seen = new Set();
  const rows = [];

  // CSV è¡¨é ­ï¼ˆå›ºå®šé †åºï¼‰
  rows.push(['åç¨±', 'ç·¯åº¦', 'ç¶“åº¦', 'è©•åˆ†', 'åœ°å€', 'é¡å‹', 'ç”¨æˆ¶è©•åˆ†ç¸½æ•¸']);

  const keywordNorm = String(keyword).trim();
  let pageToken = null;
  let loopCount = 0;

  do {
    let url =
      `${baseUrl}?query=${encodeURIComponent(keywordNorm)}` +
      `&location=${lat},${lng}` +
      `&radius=${radius}` +
      `&language=zh-TW` +
      `&key=${apiKey}`;

    if (pageToken) {
      url += `&pagetoken=${pageToken}`;
      Utilities.sleep(2000);
    }

    const response = UrlFetchApp.fetch(url, { muteHttpExceptions: true });
    const json = JSON.parse(response.getContentText());

    if (json.status !== 'OK' && json.status !== 'ZERO_RESULTS') break;

    (json.results || []).forEach(p => {
      const name = p.name || '';
      if (!name.includes(keywordNorm)) return;

      if (!seen.has(p.place_id)) {
        seen.add(p.place_id);
        rows.push([
          name,
          p.geometry?.location?.lat ?? '',
          p.geometry?.location?.lng ?? '',
          p.rating ?? '',
          p.formatted_address || '',
          (p.types || []).join('|'),
          p.user_ratings_total ?? ''
        ]);
      }
    });

    pageToken = json.next_page_token;
    loopCount++;
  } while (pageToken && loopCount < 3);

  const csv = rows.map(row =>
    row.map(v => `"${String(v).replace(/"/g, '""')}"`).join(',')
  ).join('\n');

  return csv;
}</textarea>

    <textarea id="index-html-text" class="hidden"><!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>Google Places CSV æŸ¥è©¢</title>
</head>
<body>
  <h1>æŸ¥è©¢ Google Places ä¸¦è¼¸å‡º CSV</h1>
  <form id="searchForm">
    <label>é—œéµå­—ï¼š
      <input type="text" id="keyword" required>
    </label><br>
    <label>ç¶“ç·¯åº¦ï¼ˆlat,lngï¼‰ï¼š
      <input type="text" id="coords" placeholder="24.75,121.74" required>
    </label><br>
    <label>è·é›¢ï¼ˆå…¬å°ºï¼‰ï¼š
      <input type="number" id="radius" required>
    </label><br><br>
    <button type="submit">æŸ¥è©¢ä¸¦ä¸‹è¼‰ CSV</button>
  </form>
  <hr>
  <div id="message"></div>
  <script>
    document.getElementById('searchForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const keyword = document.getElementById('keyword').value;
      const coords = document.getElementById('coords').value.split(',');
      const radius = document.getElementById('radius').value;
      const messageDiv = document.getElementById('message');
      if (coords.length < 2) {
        messageDiv.textContent = 'è«‹è¼¸å…¥æ­£ç¢ºçš„ç¶“ç·¯åº¦æ ¼å¼';
        return;
      }
      const lat = coords[0].trim();
      const lng = coords[1].trim();
      messageDiv.textContent = 'æŸ¥è©¢ä¸­ï¼Œè«‹ç¨å€™â€¦';
      google.script.run
        .withSuccessHandler(function(csv) {
          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'places_results.csv';
          a.click();
          URL.revokeObjectURL(url);
          messageDiv.textContent = 'å®Œæˆï¼Œå·²ä¸‹è¼‰ CSV';
        })
        .withFailureHandler(function(err) {
          messageDiv.textContent = 'éŒ¯èª¤ï¼š' + err.message;
        })
        .searchPlacesCSV(keyword, lat, lng, radius);
    });
  </script>
</body>
</html></textarea>

    <script>
        let currentStep = 1;
        const totalSteps = 5;

        // åˆå§‹åŒ–é¡¯ç¤ºåŸå§‹ç¢¼
        document.getElementById('code-gs-display').textContent = document.getElementById('code-gs-text').value;
        document.getElementById('index-html-display').textContent = document.getElementById('index-html-text').value;

        function startTutorial() {
            document.getElementById('intro-section').classList.add('hidden');
            document.getElementById('tutorial-section').classList.remove('hidden');
        }

        function changeStep(delta) {
            document.getElementById(`step${currentStep}`).classList.remove('active');
            currentStep += delta;
            
            if (currentStep > totalSteps) {
                alert('æ•™ç¨‹çµæŸï¼è«‹è¿”å›å°ˆæ¡ˆå®Œæˆéƒ¨ç½²ã€‚');
                location.reload();
                return;
            }

            document.getElementById(`step${currentStep}`).classList.add('active');
            document.getElementById('progress-bar').style.width = `${(currentStep / totalSteps) * 100}%`;
            document.getElementById('prevBtn').disabled = currentStep === 1;
            document.getElementById('nextBtn').innerText = currentStep === totalSteps ? 'å®Œæˆå»ºç½®' : 'ä¸‹ä¸€æ­¥';
        }

        function copyCode(id) {
            const text = document.getElementById(id);
            text.select();
            document.execCommand('copy');
            alert('ä»£ç¢¼å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
        }
    </script>
</body>
</html>
